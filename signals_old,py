import os
import pandas as pd

def detect_rsi_signals(df, ticker):
    buy_mask = (df['RSI'] < 30)
    sell_mask = (df['RSI'] > 70)

    signal_rows = []
    for idx in df.index:
        if buy_mask.loc[idx]:
            signal_rows.append({'datetime': idx, 'signal': 'BUY'})
        elif sell_mask.loc[idx]:
            signal_rows.append({'datetime': idx, 'signal': 'SELL'})

    if not signal_rows:
        print(f" No RSI signals for {ticker}")
        return None, None, None

    # 砖专转 住
    signal_df = pd.DataFrame(signal_rows)
    signal_path = os.path.join("data", ticker, "signals.csv")
    os.makedirs(os.path.dirname(signal_path), exist_ok=True)

    # 注转 驻转
    if os.path.exists(signal_path):
        existing = pd.read_csv(signal_path, parse_dates=["datetime"])
        combined = pd.concat([existing, signal_df])
        combined.drop_duplicates(subset=["datetime", "signal"], inplace=True)
        combined.sort_values(by="datetime", inplace=True)
        combined.to_csv(signal_path, index=False)
        print(f" Updated {len(signal_rows)} RSI signals for {ticker}")
    else:
        signal_df.to_csv(signal_path, index=False)
        print(f" Saved {len(signal_rows)} new RSI signals for {ticker}")

    return buy_mask, sell_mask, signal_df
